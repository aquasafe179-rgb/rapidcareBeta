<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Super Admin - RapidCare</title>
  <link rel="stylesheet" href="/css/styles.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    /* Premium Admin Styles */
    .admin-container {
      display: flex;
      min-height: 100vh;
      background: var(--bg-body);
    }

    .sidebar {
      width: 280px;
      background: #fff;
      border-right: 1px solid var(--border-color);
      display: flex;
      flex-direction: column;
      position: fixed;
      height: 100vh;
      z-index: 100;
      box-shadow: var(--shadow-sm);
    }

    .sidebar-header {
      padding: var(--spacing-lg);
      border-bottom: 1px solid var(--border-color);
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
    }

    .sidebar-nav {
      padding: var(--spacing-md);
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: var(--spacing-xs);
    }

    .nav-item {
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
      padding: 0.75rem 1rem;
      border-radius: var(--border-radius);
      color: var(--text-muted);
      font-weight: 500;
      cursor: pointer;
      transition: var(--transition-base);
    }

    .nav-item:hover {
      background: rgba(11, 110, 253, 0.05);
      color: var(--primary-color);
    }

    .nav-item.active {
      background: rgba(11, 110, 253, 0.1);
      color: var(--primary-color);
      font-weight: 600;
    }

    .main-content {
      flex: 1;
      margin-left: 280px;
      padding: var(--spacing-lg);
    }

    .stat-card {
      background: white;
      border-radius: 16px;
      padding: 1.5rem;
      border: 1px solid var(--border-color);
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .stat-icon {
      width: 48px;
      height: 48px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.25rem;
      font-weight: bold;
    }
  </style>
</head>

<body>

  <!-- Login Section -->
  <div id="login-section" class="container"
    style="display: flex; align-items: center; justify-content: center; min-height: 100vh;">
    <div class="card glass shadow-lg"
      style="width: 100%; max-width: 400px; border-top: 4px solid var(--primary-color);">
      <div class="card-header text-center border-0 pb-0">
        <h2 class="text-primary font-bold">System Authority</h2>
        <p class="text-muted">Super Admin Terminal Access</p>
      </div>
      <div class="p-4">
        <div class="form-group"><label class="form-label uppercase text-xs font-bold text-muted">Admin
            Identifier</label><input id="admin-user" class="form-control" placeholder="Administrator" /></div>
        <div class="form-group"><label class="form-label uppercase text-xs font-bold text-muted">Security
            Key</label><input id="admin-pass" type="password" class="form-control" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" /></div>
        <button onclick="loginAdmin()" class="btn btn-primary btn-block py-2 font-bold">Authenticate</button>
        <div id="login-msg" class="mt-3 text-danger text-center text-xs font-bold"></div>
        <div class="text-center mt-4">
          <button onclick="createInitialAdmin()" class="btn btn-xs btn-link text-muted font-bold uppercase"
            style="font-size: 0.65rem;">Provision Initial Authority</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Dashboard Section -->
  <div id="dashboard-section" class="admin-container" style="display: none;">
    <aside class="sidebar">
      <div class="sidebar-header">
        <img src="/images/logo.png" alt="Logo" style="height: 30px;">
        <h3 class="text-primary mb-0 ml-2" style="font-size: 1.1rem;">RapidCare</h3>
      </div>
      <nav class="sidebar-nav">
        <a class="nav-item active" onclick="showSection('overview')"><span>üìä</span> System Cluster</a>
        <a class="nav-item" onclick="showSection('register-hospital')"><span>üè•</span> Node Registration</a>
        <a class="nav-item" onclick="showSection('dbms')"><span>üóÑÔ∏è</span> Master DBMS</a>
        <div style="margin-top: auto; border-top: 1px solid var(--border-color); padding-top: 1rem;">
          <a class="nav-item text-danger font-bold" onclick="logout()"><span>üö™</span> Terminal Exit</a>
        </div>
      </nav>
    </aside>

    <main class="main-content">
      <!-- Overview -->
      <div id="section-overview" class="animate-fade-in">
        <div class="mb-4">
          <h2 class="font-bold mb-1">System Topology</h2>
          <p class="text-muted text-sm">Cluster health and resource monitoring</p>
        </div>
        <div class="grid grid-cols-4 gap-md mb-5" id="stats-container">
          <!-- Stats injected here -->
        </div>
      </div>

      <!-- Register Hospital -->
      <div id="section-register-hospital" class="animate-fade-in" style="display: none;">
        <div class="mb-4">
          <h2 class="font-bold mb-1">Provision New Node</h2>
          <p class="text-muted text-sm">Onboard hospital facility to the network</p>
        </div>
        <div class="card border-0 shadow-sm" style="max-width: 900px;">
          <div class="p-4">
            <div class="grid grid-cols-2 gap-md">
              <div class="form-group"><label class="text-xs uppercase font-bold text-muted">Unique Hospital
                  ID</label><input id="h-id" class="form-control" placeholder="HOSP-RAIPUR-001" /></div>
              <div class="form-group"><label class="text-xs uppercase font-bold text-muted">Legal Facility
                  Name</label><input id="h-name" class="form-control" placeholder="General Medical Center" /></div>
              <div class="form-group"><label class="text-xs uppercase font-bold text-muted">Portal Authorization
                  Key</label><input id="h-pass" type="password" class="form-control" value="test@1234" /></div>
              <div class="form-group"><label class="text-xs uppercase font-bold text-muted">Emergency Dispatch
                  Contact</label><input id="h-contact" class="form-control" placeholder="+91 XXXX XXX XXX" /></div>
              <div class="form-group" style="grid-column: 1/-1;"><label
                  class="text-xs uppercase font-bold text-muted">Physical Deployment Address</label><input
                  id="h-address" class="form-control" placeholder="Street, Sector, City" /></div>
              <div class="form-group" style="grid-column: 1/-1;">
                <label class="text-xs uppercase font-bold text-muted">Map Synchronization URL</label>
                <input id="h-googleMapUrl" class="form-control" placeholder="Google Maps link"
                  onchange="onMapUrlChange(this.value)" />
                <small class="text-muted text-xs">Precise coordinates will be auto-indexed from the link
                  payload.</small>
              </div>
              <div class="form-group"><label class="text-xs uppercase font-bold text-muted">Geospatial
                  Latitude</label><input id="h-lat" type="number" step="any" class="form-control" /></div>
              <div class="form-group"><label class="text-xs uppercase font-bold text-muted">Geospatial
                  Longitude</label><input id="h-lng" type="number" step="any" class="form-control" /></div>
            </div>
            <button onclick="registerHospital()" class="btn btn-primary mt-4 px-5 font-bold">Verify & Register
              Node</button>
            <div id="reg-msg" class="mt-3"></div>
          </div>
        </div>
      </div>

      <!-- Master DBMS -->
      <div id="section-dbms" class="animate-fade-in" style="display: none;">
        <div class="flex justify-between items-center mb-4">
          <div>
            <h2 class="font-bold mb-0">Master Data Terminal</h2>
            <p class="text-muted text-sm">Direct object management across all clusters</p>
          </div>
          <div class="flex gap-sm">
            <select id="db-collection" class="form-control font-bold" style="min-width: 200px;"
              onchange="loadMasterData(this.value)">
              <option value="hospitals">üè• Hospitals</option>
              <option value="doctors">üë®‚Äç‚öïÔ∏è Doctors</option>
              <option value="ambulances">üöë Ambulances</option>
              <option value="beds">üõèÔ∏è Beds</option>
              <option value="emergencies">üö® Emergencies</option>
              <option value="nurses">üë©‚Äç‚öïÔ∏è Nurses</option>
              <option value="announcements">üì¢ Announcements</option>
              <option value="bloodbank">ü©∏ Blood Bank</option>
              <option value="calllogs">üìû Call Logs</option>
            </select>
            <button onclick="loadMasterData()" class="btn btn-outline btn-sm font-bold">Sync</button>
          </div>
        </div>

        <div class="card border-0 shadow-sm p-0 overflow-hidden">
          <div class="overflow-auto">
            <table id="master-table" class="table mb-0" style="min-width: 1000px;">
              <thead class="bg-light">
                <tr id="master-headers" class="text-xs uppercase font-bold text-muted"></tr>
              </thead>
              <tbody id="master-body" class="text-sm"></tbody>
            </table>
          </div>
          <div id="master-loader" class="p-5 text-center text-muted col-span-full">
            <div class="spinner-border text-primary spinner-border-sm mr-2"></div> Syncing objects...
          </div>
          <div id="master-empty" class="p-5 text-center text-muted font-medium">Primary object cache is empty or
            selection required</div>
        </div>
      </div>
    </main>
  </div>
  </main>
  </div>

  <!-- Edit Record Modal -->
  <div id="edit-modal" class="modal"
    style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; align-items: center; justify-content: center;">
    <div class="bg-white p-4 rounded shadow-lg" style="width: 90%; max-width: 600px;">
      <h3 class="mb-3">Edit Record</h3>
      <div class="form-group">
        <label>JSON Data</label>
        <textarea id="edit-json" class="form-control" rows="15"
          style="font-family: monospace; font-size: 0.85rem;"></textarea>
        <small class="text-muted">Edit fields below and save. IDs are protected.</small>
      </div>
      <input type="hidden" id="edit-id" />
      <input type="hidden" id="edit-col" />
      <div class="flex justify-end gap-sm mt-4">
        <button onclick="document.getElementById('edit-modal').style.display='none'"
          class="btn btn-outline">Cancel</button>
        <button onclick="saveMasterEdit()" class="btn btn-primary">Save Changes</button>
      </div>
    </div>
  </div>

  <script src="/js/client.js"></script>
  <!-- Reusing client.js utility functions if compatible, or just standard fetch -->
  <script>
    // Inline script for Admin logic
    const API_URL = '/api/admin';

    // Check login status on load
    document.addEventListener('DOMContentLoaded', () => {
      const token = localStorage.getItem('adminToken') || localStorage.getItem('jwt');
      if (localStorage.getItem('role') === 'superadmin' && token) {
        showDashboard();
      }
    });

    async function loginAdmin() {
      const u = document.getElementById('admin-user').value;
      const p = document.getElementById('admin-pass').value;

      try {
        const res = await fetch(`${API_URL}/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ role: 'superadmin', username: u, password: p }) // consistent with auth.js
        });
        const data = await res.json();

        if (res.ok) {
          localStorage.setItem('adminToken', data.token);
          localStorage.setItem('jwt', data.token);
          localStorage.setItem('role', 'superadmin');
          showDashboard();
        } else {
          document.getElementById('login-msg').innerText = data.message;
        }
      } catch (e) {
        document.getElementById('login-msg').innerText = 'Connection Refused: ' + e.message;
      }
    }

    async function createInitialAdmin() {
      const username = prompt("Enter Username:");
      const password = prompt("Enter Password:");
      if (!username || !password) return;

      try {
        const res = await fetch(`${API_URL}/create-initial`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, password })
        });
        const data = await res.json();
        alert(data.message);
      } catch (e) {
        alert(e.message);
      }
    }

    function logout() {
      localStorage.removeItem('superAdminToken');
      localStorage.removeItem('adminToken');
      localStorage.removeItem('jwt');
      localStorage.removeItem('role');
      location.reload();
    }

    function showDashboard() {
      document.getElementById('login-section').style.display = 'none';
      document.getElementById('dashboard-section').style.display = 'flex';
      loadStats();
    }

    function showSection(id) {
      document.getElementById('section-overview').style.display = 'none';
      document.getElementById('section-register-hospital').style.display = 'none';
      document.getElementById('section-dbms').style.display = 'none';
      document.getElementById(`section-${id}`).style.display = 'block';

      document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
      const activeBtn = Array.from(document.querySelectorAll('.nav-item')).find(el => el.innerText.toLowerCase().includes(id.replace('-', ' ')));
      if (activeBtn) activeBtn.classList.add('active');

      if (id === 'dbms') loadMasterData();
    }

    async function loadMasterData(collection) {
      const col = collection || document.getElementById('db-collection').value;
      const loader = document.getElementById('master-loader');
      const empty = document.getElementById('master-empty');
      const table = document.getElementById('master-table');
      const headers = document.getElementById('master-headers');
      const body = document.getElementById('master-body');

      loader.style.display = 'block';
      empty.style.display = 'none';
      table.style.display = 'none';
      body.innerHTML = '';
      headers.innerHTML = '';

      try {
        const res = await fetch(`/api/master/${col.replace('üè• ', '').replace('üë®‚Äç‚öïÔ∏è ', '').replace('üöë ', '').replace('üõèÔ∏è ', '').replace('üö® ', '').replace('üë©‚Äç‚öïÔ∏è ', '').replace('üì¢ ', '').replace('ü©∏ ', '').replace('üìû ', '').toLowerCase()}`, {
          headers: { 'Authorization': `Bearer ${localStorage.getItem('jwt')}` }
        });
        const data = await res.json();

        if (data.success && data.data.length > 0) {
          const first = data.data[0];
          const keys = Object.keys(first).filter(k => k !== '__v'); // Filter out Mongo version

          // Headers
          keys.forEach(k => {
            const th = document.createElement('th');
            th.innerText = k;
            th.className = 'py-3 px-4';
            headers.appendChild(th);
          });
          const actionTh = document.createElement('th');
          actionTh.innerText = 'CONTROL';
          actionTh.className = 'py-3 px-4';
          headers.appendChild(actionTh);

          // Body
          data.data.forEach(row => {
            const tr = document.createElement('tr');
            tr.className = 'border-bottom border-light';
            keys.forEach(k => {
              const td = document.createElement('td');
              td.className = 'py-3 px-4';
              const val = row[k];
              if (typeof val === 'object') {
                td.innerHTML = `<span class="text-xs text-muted font-mono">${JSON.stringify(val).substring(0, 40)}...</span>`;
              } else {
                td.innerText = val;
              }
              tr.appendChild(td);
            });
            const actionTd = document.createElement('td');
            actionTd.className = 'py-3 px-4 flex gap-xs';
            actionTd.innerHTML = `
              <button onclick='editMasterRecord(${JSON.stringify(row).replace(/'/g, "&apos;")}, "${col}")' class="btn btn-xs btn-outline-info rounded px-2">Edit</button>
              <button onclick="deleteMasterRecord('${col}', '${row._id}')" class="btn btn-xs btn-outline-danger rounded px-2">Delete</button>
            `;
            tr.appendChild(actionTd);
            body.appendChild(tr);
          });

          table.style.display = 'table';
          loader.style.display = 'none';
        } else {
          loader.style.display = 'none';
          empty.style.display = 'block';
          empty.innerText = 'No records found in this collection';
        }
      } catch (e) {
        loader.style.display = 'none';
        empty.style.display = 'block';
        empty.innerText = 'Error loading data: ' + e.message;
      }
    }

    function editMasterRecord(row, col) {
      document.getElementById('edit-id').value = row._id;
      document.getElementById('edit-col').value = col;
      document.getElementById('edit-json').value = JSON.stringify(row, null, 2);
      document.getElementById('edit-modal').style.display = 'flex';
    }

    async function saveMasterEdit() {
      const id = document.getElementById('edit-id').value;
      const col = document.getElementById('edit-col').value;
      let body;
      try {
        body = JSON.parse(document.getElementById('edit-json').value);
      } catch (e) {
        alert('Invalid JSON: ' + e.message);
        return;
      }

      try {
        const res = await fetch(`/api/master/${col}/${id}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${localStorage.getItem('superAdminToken')}`
          },
          body: JSON.stringify(body)
        });
        const data = await res.json();
        if (data.success) {
          alert('Record updated successfully');
          document.getElementById('edit-modal').style.display = 'none';
          loadMasterData(col);
        } else {
          alert('Update failed: ' + data.message);
        }
      } catch (e) {
        alert('Error: ' + e.message);
      }
    }

    async function deleteMasterRecord(collection, id) {
      if (!confirm('Are you sure you want to delete this record permanentally?')) return;

      try {
        const res = await fetch(`/api/master/${collection}/${id}`, {
          method: 'DELETE',
          headers: { 'Authorization': `Bearer ${localStorage.getItem('superAdminToken')}` }
        });
        const data = await res.json();
        if (data.success) {
          alert('Record deleted successfully');
          loadMasterData(collection);
        } else {
          alert('Delete failed: ' + data.message);
        }
      } catch (e) {
        alert('Error: ' + e.message);
      }
    }

    async function loadStats() {
      try {
        const res = await fetch(`${API_URL}/stats`, {
          headers: { 'Authorization': `Bearer ${localStorage.getItem('superAdminToken')}` }
        });
        const data = await res.json();

        const container = document.getElementById('stats-container');
        container.innerHTML = `
          <div class="card text-center"><h3>${data.hospitals}</h3><small>Hospitals</small></div>
          <div class="card text-center"><h3>${data.doctors}</h3><small>Doctors</small></div>
          <div class="card text-center"><h3>${data.ambulances}</h3><small>Ambulances</small></div>
          <div class="card text-center"><h3>${data.activeEmergencies}</h3><small>Active Emergencies</small></div>
        `;
      } catch (e) {
        console.error(e);
      }
    }

    async function registerHospital() {
      const body = {
        hospitalId: document.getElementById('h-id').value.trim(),
        name: document.getElementById('h-name').value.trim(),
        password: document.getElementById('h-pass').value,
        contact: document.getElementById('h-contact').value.trim(),
        address: { city: document.getElementById('h-address').value.trim() },
        googleMapUrl: document.getElementById('h-googleMapUrl').value.trim(),
        location: {
          lat: parseFloat(document.getElementById('h-lat').value),
          lng: parseFloat(document.getElementById('h-lng').value)
        }
      };

      if (!body.hospitalId || !body.name) {
        alert('Hospital ID and Name are required');
        return;
      }

      try {
        const res = await fetch(`${API_URL}/register-hospital`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${localStorage.getItem('superAdminToken')}`
          },
          body: JSON.stringify(body)
        });
        const data = await res.json();

        const msg = document.getElementById('reg-msg');
        if (res.ok) {
          msg.innerHTML = '<span class="text-success">Hospital Registered!</span>';
          loadStats();
        } else {
          msg.innerHTML = `<span class="text-danger">${data.message}</span>`;
        }
      } catch (e) {
        document.getElementById('reg-msg').innerText = e.message;
      }
    }

    function onMapUrlChange(url) {
      // Basic extraction regex for lat,lng
      const match = url.match(/@(-?\d+\.\d+),(-?\d+\.\d+)/) || url.match(/q=(-?\d+\.\d+),(-?\d+\.\d+)/);
      if (match) {
        document.getElementById('h-lat').value = match[1];
        document.getElementById('h-lng').value = match[2];
        notify('Coordinates extracted from URL!', 'success');
      }
    }

    function notify(msg, type) {
      // Basic alert if localized notify isn't available
      console.log(`[${type}] ${msg}`);
      if (type === 'error') alert('Error: ' + msg);
    }
  </script>
</body>

</html>